<script lang='ts' setup>
import Chart from 'primevue/chart'
import { computed, reactive, watch } from 'vue'
import { useAsyncData } from '@0x-jerry/vue-kit'
import { selectionTable } from '../database'
import DatePicker from 'primevue/datepicker'
import dayjs from 'dayjs'

const query = reactive({
  dates: [
    dayjs().add(-7, 'd').startOf('d').toDate(),
    dayjs().endOf('d').toDate(),
  ],
})

const selectionData = useAsyncData(() => {
  const start = dayjs(query.dates[0]).startOf('d')
  const end = dayjs(query.dates[1]).endOf('d')

  return selectionTable.groupDataBySelectedText({ start, end })
}, [])

watch(
  () => query,
  () => {
    const length = query.dates.filter((n) => n).length
    if (length < 2) return

    selectionData.load()
  },
  {
    deep: true,
    immediate: true,
  },
)

const chartData = computed(() => {
  const data = selectionData.data.value || []

  return {
    labels: data.map((n) => n.selected),
    datasets: [
      {
        data: data.map((n) => n.count),
      },
    ],
  }
})

const chartOptions = computed(() => {
  return {
    plugins: {
      legend: {
        labels: {
          usePointStyle: true,
        },
      },
    },
  }
})
</script>

<template>
  <div class="p-4">
    <div class="query mb-2">
      <span>选择时间：</span>
      <DatePicker v-model="query.dates" selectionMode="range" :numberOfMonths="2" :manualInput="false" />
    </div>
    <div class="flex justify-center">
      <Chart v-if="chartData.labels.length" type="pie" :data="chartData" :options="chartOptions" class="w-400px" />
      <div v-else class="text-center text-gray h-100px text-2xl flex items-center">
        <div>暂无数据</div>
      </div>
    </div>
  </div>
</template>

<style lang='scss' scoped></style>
